<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lyz.user.dao.OrderDao" >
    
     <resultMap type="com.lyz.user.bean.Order" id="OrderResult">
        <id column="oid" property="oid" jdbcType="VARCHAR"/>
        <collection property="items" column="oid" javaType="ArrayList" 
            ofType="com.lyz.user.bean.OrderItem"    select="findOrderItemByOid" />
    </resultMap>
    
    <resultMap type="com.lyz.user.bean.OrderItem" id="ItemResult">
        <id column="itemid" property="itemid" jdbcType="VARCHAR"/>
        <association property="product" column="itemid" 
            select="com.lyz.user.dao.ProductDao.selectProductByItemid"  javaType="com.lyz.user.bean.Product" />
        <association property="order" column="oid" select="findOrderById" javaType="com.lyz.user.bean.Order" />
    </resultMap>
  
    <!-- 插入一条订单记录 -->
    <insert id="saveOrder" parameterType="com.lyz.user.bean.Order">
    	insert into orders (oid,ordertime,total,address, name,telephone,uid)
        values (#{oid},#{ordertime},#{total}, #{address}, #{name},#{telephone},#{user.uid} )
    </insert>
    <insert id="saveOrderItem" parameterType="com.lyz.user.bean.OrderItem">
        insert into orderitem(itemid,count,subtotal,pid,oid) values(#{itemid},#{count},#{subtotal},#{product.pid},#{order.oid})
    </insert>
    
    <select id="findOrderById" parameterType="java.lang.String" resultType="com.lyz.user.bean.Order">
        select * from orders o where o.oid=#{oid}
    </select>
   
    <select id="findUsersOrders" resultMap="OrderResult" parameterType="java.lang.String">
        select * from orders o where o.uid=#{uid} order by ordertime desc
    </select>
    
    <select id="findOrderItemByOid" resultMap="ItemResult" parameterType="java.lang.String">
        select * from orderitem where oid=#{oid} 
    </select>
        
    <update id="updateOrderState" parameterType="com.lyz.user.bean.Order">
        update orders set state=#{0} where oid=#{1}
    </update>
    
    <delete id="delteOrderById" parameterType="java.lang.String">
        delete from orders where oid=#{oid}
    </delete>
    
</mapper>